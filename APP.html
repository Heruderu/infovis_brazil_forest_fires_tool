<!DOCTYPE html>
<html>

	<head>
	  <meta charset="utf-8">
	  <script src="https://d3js.org/d3.v5.js"></script>
      <script src="https://d3js.org/topojson.v1.min.js"></script>
      <script type="text/javascript" src="barLib.js"></script>
      <script type="text/javascript" src="filter.js"></script>
	  <style>
              html
             body {
                 position:static;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                background-color: green;
            }
            #div1{
                position:absolute;
                width: 50%;
                height: 100%;
            
                
                background-color: teal;
            }
            #div2{
                position:absolute;
                width: 50%;
                height: 50%;
                left: 50%;
                top:0px;
                
                background-color:yellowgreen;
            }
            #div3{
                position:fixed;
                width: 50%;
                height: 50%;
                left: 50%;
                top:50%;
                
                background-color:blue;
            }
            #filter_container1{
                position:fixed;
                left: 57%;
                top:0%;
            }
            #filter_container2{
                position:fixed;
                left: 57%;
                top:50%;
            }
            
            #dropdown1 {
                position:fixed;
                left:50%;
                top:0%;
                display: inline-block;
                }
            #dropdown2 {
                position:fixed;
                left:50%;
                top:50%;
                display: inline-block;
                }
            .dropdown-content {
                display: none;
                position: absolute;
                background-color: #f1f1f1;
                min-width: 160px;
                overflow: auto;
                box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
                z-index: 1;
            }

            
	  </style>

     
	</head>

	<body>

        <div id = "div1"></div>
        <div id = "div2" ></div>
            <div class="dropdown" id="dropdown1">
                    <button onclick="myFunction()" class="dropbtn">Dropdown</button>
                    <div id="myDropdown1" class="dropdown-content">
                    <a href="#State">Home</a>
                    <a href="#about">About</a>
                    <a href="#contact">Contact</a>
            </div>
            <div class="filter_container" id ="filter_container1">
                    <label><input type="range" id="filter_slider"/> </label>
                    <p id="label"> </p> 
            </div>     
     <div id = "div3" ></div>
     
        <div class="dropdown" id="dropdown2">
                <button onclick="myFunction()" class="dropbtn">Dropdown</button>
                <div id="myDropdown2" class="dropdown-content">
                <a href="#State">Home</a>
                <a href="#about">About</a>
                <a href="#contact">Contact</a>
        </div>

        
        <div class="filter_container" id ="filter_container2">
                <label><input type="range" id="filter_slider"/> </label>
                <p id="label"> </p> 
        </div>


            
            
        <script type="text/javascript">
            if(document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', afterLoaded);
            } else {
                //The DOMContentLoaded event has already fired. Just run the code.
                afterLoaded();
            }
            
            function afterLoaded() {
            
            
            let mapLoaded = d3.json("brazilstates.json");
            mapLoaded.then(loadMap);
            }
        </script>
    





    
    <script type="text/javascript">
        let margin = 75,
           width = 1400 - margin,
           height = 600-margin;

       //data filter
           // save state of visual variables to brush and filter
           let x_axis
           let y_axis
           let svgMap,svgBars;
           let barState=0; //0-> total, 1-> dados por ano
           let barsRect, barScales;
           let scatterCircles, scatterScales,scatterLine,scatterText;
           let raw_geo_data;
           let filteredState;
           var ele=document.getElementById('div2')
           let barheight=parseInt(ele.clientHeight);
           let countrySum;

     let barData;
    let rawData;
         function loadMap(brazilstates) {
       
                   
               let year= d3.map();
               let fires_total_state = d3.map();
               let month = d3.map();
               let state = d3.map();

               let svg = d3.select("#div1")
                              .append("svg")
                                .attr("width", width + margin)
                                .attr("height", height + margin)
                                .append('g')
                                .attr('class', 'map');

       let projection = d3.geoMercator()
           .center([-20, -15])
                   .scale(650)
                   .translate([width / 2, height / 2]);

       let path = d3.geoPath().projection(projection);

             let mapa = d3.csv("new_csv.csv")
                 .then((data) => {
                     let newdata = data.map( d => {
                                                d["Número"] = +d["Número"];
                                                d["Estado"] = d["Estado"];
                                                        
                                                return d;
                                                 });
                   rawData=newdata;  
                    fillStates(newdata);
                   // getMonthSum(newdata);
                 })
                 .catch(err => {console.log(err)});
          
             function fillStates(data) {
                 let nested = d3.nest()
                       .key(function (d) {
                           return d["Estado"];
                       })
                       .rollup(function (leaves) {
                       let total = d3.sum(leaves, function (d) {
                           return d["Número"];
                       });

                       return +total;
                       })

                       .entries(data);

         //console.log(nested);
            let numero_extent = d3.extent(nested, function (d) {
                     return d.value;
                   });

         let states = topojson.feature(brazilstates, brazilstates.objects.foo);
                 let states_contour = topojson.mesh(brazilstates, brazilstates.objects.foo.geometries);

                   let color = d3.scaleQuantize()
                   .domain(numero_extent)
                   .range(d3.schemeReds[9]);

               let legendLabels = d3.range(0, numero_extent[1], numero_extent[1]/9);
               //console.log(legendLabels);

               let legend = svg.selectAll('g.legendEntry')
                   .data(color.range())
                   .enter()
                   .append('g').attr('class', 'legendEntry');

                   legend
                   .append('rect')
                   .attr("x", 20)
                   .attr("y", function(d, i) {
                     return height - margin - i * 12;
                   })
                   .attr("width", 10)
                   .attr("height", 10)
                   .style("stroke", "black")
                   .style("stroke-width", 0.5)
                   .style("fill", function(d){return d;}); 

                 legend
                   .append('text')
                   .attr('font-size', 12)
                   .attr("x", 35) //leave 5 pixel space after the <rect>
                   .attr("y", function(d, i) {
                      return height - margin - i * 12;
                   })
                   .attr("dy", "0.8em") //place text one line *below* the x,y point
                   .text(function(d,i) {
                       var extent = color.invertExtent(d);
                       //extent will be a two-element array, format it however you want:
                       var format = d3.format("0.0f");
                       if (i == 0) {
                           return 0.0 + " < " + format(+extent[1]);
                       }
                       if (i == d.length + 1) {
                           return "> " + format(+extent[1]);
                       }
                       return format(+extent[0]) + " - " + format(+extent[1]);
                   });


               let total = 0;
                 svg.append("g")
                     .selectAll("path")
                     .data(states.features)
                       .enter()
                           .append("path")
                               .attr("class", "state")
                               .attr("stroke", "gray")
                               .attr("fill", function(d) {
                                   let value = nested.forEach(function funcion(n) {
                                       fires_total_state.set(n.key, n.value);
                                           if (n.key == d.properties.codarea) {
                                           total = n.value;
                                       }
                                   })
                                   return color(total);		
                               })
                               .attr("d", path)
                               .on("mouseover", handleMouseOver)
                               .on("mouseout", handleMouseOut)
                               .on("click", function(d) { // selection scatter
                                   //console.log(d.properties.codarea)
                                   getSingleStateData(d.properties.codarea);
                                   
                               });
                   
                 

                   


                 svg.append("g")
                   .append("path")
                   .datum(states_contour)
                   .attr("d", path)
                   .attr("class", "state_contour");

                   function handleMouseOver(d, i) {
                       d3.select(this).attr("stroke","black");
                       d3.select(this).attr("stroke-width", 3);
                      // console.log(d.properties.codarea);
                       //console.log(fires_total_state.get(d.properties.codarea));
                   svg.append("text").attr("id", function() {return "t" + fires_total_state.get(d.properties.codarea);})
                       .attr("x", function() { return margin + 80; })
               .attr("y", function() { return margin - 60 ; })
               .attr("text-anchor","middle")
               .attr("fill","black")
               .attr("size",200)
               .text(function() {return d.properties.codarea + ": " + fires_total_state.get(d.properties.codarea)
               + " focos de incêndio."});
           }

           function handleMouseOut(d, i) {
             d3.select(this).attr("stroke", "gray");
             d3.select(this).attr("stroke-width", 1);
             d3.select("#t" + fires_total_state.get(d.properties.codarea)).remove();
           }
       
        }
       




             //console.log(fires_total_state)
           
           d3.csv("test.csv")
               .then((data) => {
                   let newData = data.map( d => {
                       d["Ano"] = +d["Ano"]; //cast to float
                       d["Numero"] = +d["Numero"]
                       return d;
                   });

                   let ret=setupVis(newData,"#div2");//funçoes
                   setupVis(newData,"#div3");
                   svgBars=ret.svg;
                   barScales=ret.scales;
                                   });
        
         
                                   //filteredState=                        
           //setupVis(filteredState)

           function getSingleStateData(key){
               filteredState= rawData.filter(d=> d.Estado===key);
               // console.table(filteredState)   
               if(barState==0){
                   updateBars(svgBars, barScales, filteredState);
                   
               }
               else{
                   drawBars(svgBars, barScales, filteredState);
                   barState=0
               }
           }
           
        
           
         

           let slider = d3.select("#filter_slider");
           let label = d3.select("#label");
           let min = 1999 
               max = 2016
            slider
               .attr("min", min)
               .attr("max", max)
               .attr("value", 1)
               .attr("step", 1)
               .on("input", function(d) {
                   label.text(this.value); // use `this` on the place of slider
                   let filteredStatePerYear= filteredState.filter(d=> d.Ano===this.value);
                   if(barState==0){
                       drawBars(svgBars, barScales, filteredStatePerYear);
                       barState=1;
                   }
                   else
                       updateBars(svgBars, barScales, filteredStatePerYear);
               })        
               
       }
     </script>
	</body>
